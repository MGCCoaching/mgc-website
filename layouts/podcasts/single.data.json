{{- /* ────────────────────────────────────────────────
     SINGLE.DATA.JSON MASTER TEMPLATE
     Génère un JSON complet pour un épisode de podcast
     avec toutes les infos, audio, image, chapters, etc.
   ──────────────────────────────────────────────── */ -}}

{{- /* ───────────── AUDIO ───────────── */ -}}
{{- $audioUrl := "" -}}
{{- $audioFormat := .Params.audio_format | default "audio/mpeg" -}}
{{- $fileSize := .Params.file_size_bytes | default 0 -}}

{{- /* 1️⃣ PRIORITÉ 1 : CDN / Decap */ -}}
{{- $prefix := .Params.audio_url_prefix | default "" -}}
{{- $fileName := .Params.file_name | default "" -}}
{{- if and $prefix $fileName -}}
  {{- $seasonFormatted := printf "s%02d" (int (.Params.season | default 1)) -}}
  {{- $audioUrl = printf "%s/%s/%s" $prefix $seasonFormatted $fileName -}}
{{- end -}}

{{- /* 2️⃣ PRIORITÉ 2 : Fichier local */ -}}
{{- if not $audioUrl -}}
  {{- $audioFile := .Params.audio_file -}}
  {{- $resource := "" -}}
  {{- if and $audioFile (not (hasPrefix $audioFile "http")) (not (strings.Contains $audioFile "/")) -}}
    {{- $resource = .Resources.GetMatch $audioFile -}}
  {{- else if not $audioFile -}}
    {{- $resource = index (.Resources.ByType "audio") 0 -}}
  {{- end -}}
  {{- with $resource -}}
    {{- $audioUrl = .Permalink -}}
    {{- $audioFormat = .MediaType.Type -}}
    {{- if eq (int $fileSize) 0 -}}
      {{- if .Data.Size -}}
        {{- $fileSize = .Data.Size -}}
      {{- else if .Data.Stat -}}
        {{- $fileSize = .Data.Stat.Size -}}
      {{- else -}}
        {{- $fileSize = len .Content -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* 3️⃣ PRIORITÉ 3 : URL direct */ -}}
{{- if not $audioUrl -}}
  {{- $manualUrl := .Params.audio_file | default .Params.audio_url -}}
  {{- if $manualUrl -}}
    {{- if hasPrefix $manualUrl "http" -}}
      {{- $audioUrl = $manualUrl -}}
    {{- else -}}
      {{- $audioUrl = printf "%s%s" $.Site.BaseURL (strings.TrimPrefix "/" $manualUrl) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* 4️⃣ HEAD request si externe et file_size = 0 */ -}}
{{- if and $audioUrl (hasPrefix $audioUrl "http") (eq (int $fileSize) 0) -}}
  {{- $opts := dict "method" "HEAD" -}}
  {{- with try (resources.GetRemote $audioUrl $opts) -}}
    {{- with .Value -}}
      {{- $fileSize = .Data.ContentLength | default 0 -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* ───────────── DURATION ───────────── */ -}}
{{- $durationRaw := .Params.duration | default "00:00" -}}
{{- $parts := split $durationRaw ":" -}}
{{- $durationSeconds := 0 -}}
{{- if eq (len $parts) 2 -}}
  {{- $durationSeconds = add (mul (int (index $parts 0)) 60) (int (index $parts 1)) -}}
{{- else if eq (len $parts) 3 -}}
  {{- $durationSeconds = add (add (mul (int (index $parts 0)) 3600) (mul (int (index $parts 1)) 60)) (int (index $parts 2)) -}}
{{- end -}}

{
  "podcast": {
    "title": {{ .Site.Params.podcast.title | jsonify }},
    "description": {{ .Site.Params.podcast.description | jsonify }},
    "author": {{ .Site.Params.podcast.author | jsonify }},
    "email": {{ .Site.Params.podcast.email | jsonify }},
    "host": {{ .Site.Params.podcast.host | jsonify }},
    "hostAvatar": {{ .Site.Params.podcast.hostAvatar | jsonify }},
    "language": {{ .Site.Params.podcast.language | default .Site.LanguageCode | jsonify }},
    "image": {{ .Site.Params.podcast.image | jsonify }},
    "category": {{ .Site.Params.podcast.category | jsonify }},
    "subcategory": {{ .Site.Params.podcast.subcategory | jsonify }},
    "explicit": {{ if .Site.Params.podcast.explicit }}true{{ else }}false{{ end }},
    "owner_name": {{ .Site.Params.podcast.owner_name | jsonify }},
    "owner_email": {{ .Site.Params.podcast.owner_email | jsonify }}
  },

  "uuid": {{ md5 .Permalink | jsonify }},
  "title": {{ .Title | jsonify }},
  "subtitle": {{ .Params.subtitle | default "" | jsonify }},
  "slug": {{ path.Base (strings.TrimSuffix "/" .File.Dir) | jsonify }},
  "episode_number": {{ .Params.episode_number | default 1 | int }},
  "season": {{ .Params.season | default 1 | int }},
  "status": {{ (cond .Draft "draft" "published") | jsonify }},
  "language": {{ .Params.language | default .Site.Params.podcast.language | default "fr" | jsonify }},
  "published_at": {{ .Date.Format "2006-01-02T15:04:05Z07:00" | jsonify }},
  "last_modified": {{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" | jsonify }},
  "explicit": {{ if .Params.explicit }}true{{ else }}false{{ end }},
  "episode_type": {{ .Params.episode_type | default "full" | jsonify }},
  "summary": {{ .Params.description | default (.Content | plainify | truncate 300) | jsonify }},
  "description": {{ .Params.description | default (.Content | plainify) | jsonify }},

  "audio": {
    "url": {{ $audioUrl | jsonify }},
    "format": {{ $audioFormat | jsonify }},
    "file_size_bytes": {{ $fileSize }},
    "duration_seconds": {{ $durationSeconds }}
  },

  "image": {
    "url": {{- $cover := .Params.cover | default .Params.cover_image -}}
      {{- if $cover -}}
        {{- if hasPrefix $cover "http" -}}
          {{ $cover | jsonify }}
        {{- else -}}
          {{ with .Resources.GetMatch $cover -}}
            {{ .Permalink | jsonify }}
          {{- else -}}
            {{ printf "%simg/fallback-podcast.jpg" $.Site.BaseURL | jsonify }}
          {{- end -}}
        {{- end -}}
      {{- else -}}
        {{ with index (.Resources.ByType "image") 0 -}}
          {{ .Permalink | jsonify }}
        {{- else -}}
          {{ printf "%simg/fallback-podcast.jpg" $.Site.BaseURL | jsonify }}
        {{- end -}}
      {{- end }}
  },

  "chapters": {{- if .Params.chapters }}
    {
      "version": "1.2.0",
      "chapters": [
        {{- range $i, $ch := .Params.chapters }}
          {{- if $ch.title }}
            {{- if $i }},{{ end }}
            {
              {{- $p := split $ch.time ":" -}}
              {{- $seconds := 0 -}}
              {{- if eq (len $p) 2 -}}
                {{- $seconds = add (mul (int (index $p 0)) 60) (int (index $p 1)) -}}
              {{- else if eq (len $p) 3 -}}
                {{- $seconds = add (add (mul (int (index $p 0)) 3600) (mul (int (index $p 1)) 60)) (int (index $p 2)) -}}
              {{- end -}}
              "startTime": {{ $seconds }},
              "title": {{ $ch.title | jsonify }}
            }
          {{- end }}
        {{- end }}
      ]
    }
  {{- else }} null {{- end }},

  "keywords": {{ .Params.tags | default .Site.Params.keywords | default slice | jsonify }},
  "categories": {{ .Params.categories | default slice | jsonify }},
  "hosts": {{ .Params.hosts | default slice | jsonify }},
  "guests": {{ .Params.guests | default slice | jsonify }},

  "platforms": {
    "spotify": {{ .Params.platforms.spotify | default "" | jsonify }},
    "apple_podcasts": {{ .Params.platforms.apple_podcasts | default "" | jsonify }},
    "deezer": {{ .Params.platforms.deezer | default "" | jsonify }},
    "youtube": {{ .Params.platforms.youtube | default "" | jsonify }}
  }
}
