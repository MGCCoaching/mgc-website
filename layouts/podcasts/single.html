{{ define "main" }}

{{/* ══════════════════════════════════════════════════════════════════
     DONNÉES ÉPISODE via Partial Centralisé
     ══════════════════════════════════════════════════════════════════ */}}
{{- $ep := partial "podcasts/episode-data" . -}}

{{/* ══════════════════════════════════════════════════════════════════
     SCHEMA.ORG - PodcastEpisode (SEO)
     ══════════════════════════════════════════════════════════════════ */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "name": {{ $ep.title | jsonify }},
  "description": {{ $ep.description | plainify | jsonify }},
  "url": {{ $ep.permalink | jsonify }},
  "datePublished": "{{ $ep.date.Format "2006-01-02" }}",
  {{- if $ep.audio.duration }}
  {{- $hours := div $ep.audio.duration 3600 }}
  {{- $minutes := div (mod $ep.audio.duration 3600) 60 }}
  {{- $seconds := mod $ep.audio.duration 60 }}
  "duration": "PT{{ if gt $hours 0 }}{{ $hours }}H{{ end }}{{ $minutes }}M{{ $seconds }}S",
  {{- end }}
  "episodeNumber": {{ $ep.episode_number }},
  "image": {{ $ep.image | jsonify }},
  {{- if $ep.audio.url }}
  "associatedMedia": {
    "@type": "MediaObject",
    "contentUrl": {{ $ep.audio.url | jsonify }}
  },
  {{- end }}
  "partOfSeries": {
    "@type": "PodcastSeries",
    "name": {{ site.Params.podcast.title | default "Podcast MGC Coaching" | jsonify }},
    "url": {{ "/podcasts/" | absURL | jsonify }}
  },
  "partOfSeason": {
    "@type": "PodcastSeason",
    "seasonNumber": {{ $ep.season }}
  }
  {{- with $ep.guests }}{{ if gt (len .) 0 }},
  "actor": [
    {{- range $i, $guest := . }}
    {{- if $i }},{{ end }}
    {"@type": "Person", "name": {{ $guest | jsonify }}}
    {{- end }}
  ]
  {{- end }}{{ end }}
}
</script>

{{/* ══════════════════════════════════════════════════════════════════
     CONTENU DE LA PAGE
     ══════════════════════════════════════════════════════════════════ */}}

<div class="mx-auto px-4 sm:px-6 lg:px-8 py-12 bg-primary">

    <article class="lg:flex lg:space-x-12 lg:items-start">
        
        {{/* ══════════════════════════════════════════════════════════
             SIDEBAR (Image + Player + Infos)
             ══════════════════════════════════════════════════════════ */}}
        <aside class="lg:w-1/3 mb-8 lg:mb-0">
            <div class="sticky top-12">
                
                {{/* Header Mobile */}}
                <div class="md:hidden">
                    <header class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-block bg-accent-primary text-white text-xs font-bold px-2 py-1 rounded-full">
                                S{{ $ep.season }}E{{ $ep.episode_number }}
                            </span>
                            {{ if eq $ep.episode_type "trailer" }}
                            <span class="inline-block bg-tertiary text-white text-xs px-2 py-1 rounded-full">Bande-annonce</span>
                            {{ else if eq $ep.episode_type "bonus" }}
                            <span class="inline-block bg-tertiary text-white text-xs px-2 py-1 rounded-full">Bonus</span>
                            {{ end }}
                        </div>
                        <p class="text-sm font-semibold text-tertiary uppercase">{{ $ep.subtitle | default "Podcast" }}</p>
                        <h1 class="podcast-section font-extrabold text-secondary mt-1">{{ $ep.title }}</h1>
                    </header>
                    
                    {{/* Invités - Mobile */}}
                    {{ with $ep.guests }}{{ if gt (len .) 0 }}
                    <div class="flex flex-col items-start gap-2 mb-8 p-4 border-l-4 border-t-4 border-accent-primary text-primary">
                        {{ range . }}
                        <div>
                            <span class="font-bold">Invité(e) :</span>
                            <span>{{ . }}</span>
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}{{ end }}    
                </div>
                
                {{/* Image Principale */}}
                <figure class="shadow-2xl rounded-lg overflow-hidden mb-6 relative">
                    <img src="{{ $ep.image }}" 
                         alt="Couverture de l'épisode : {{ $ep.title }}" 
                         class="w-full object-cover aspect-square">
                    <div class="absolute top-3 left-3">
                        <span class="bg-accent-primary text-white text-sm font-bold px-3 py-1 rounded-full shadow-lg">
                            S{{ $ep.season }}E{{ $ep.episode_number }}
                        </span>
                    </div>
                </figure>

                {{/* Player Audio */}}
                {{ if $ep.audio.url }}
                    {{ partial "components/podcast-player.html" . }}
                {{ else }}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <p class="text-red-600 text-sm italic flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">error</span>
                            Fichier audio indisponible.
                        </p>
                    </div>
                {{ end }}
                
                {{/* Métadonnées */}}
                <div class="p-4 my-5 bg-primary rounded-lg text-sm text-primary space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary text-lg">timer</span>
                        <span><strong>Durée :</strong> {{ .Params.duration | default "00:00" }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary text-lg">calendar_today</span>
                        <span><strong>Publié :</strong> {{ $ep.date.Format "02 janvier 2006" }}</span>
                    </div>
                    {{ if eq $ep.episode_type "trailer" }}
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary text-lg">movie</span>
                        <span><strong>Type :</strong> Bande-annonce</span>
                    </div>
                    {{ else if eq $ep.episode_type "bonus" }}
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary text-lg">star</span>
                        <span><strong>Type :</strong> Épisode bonus</span>
                    </div>
                    {{ end }}
                </div>

                {{/* Liens plateformes */}}
                {{ with .Params.platforms }}
                {{ if or .spotify .apple_podcasts .deezer .youtube }}
                <div class="mt-6 p-4 bg-primary rounded-lg">
                    <h4 class="font-bold text-primary mb-3 flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary">headphones</span>
                        Écouter sur
                    </h4>
                    <div class="flex flex-wrap gap-2">
                        {{ with .spotify }}
                        <a href="{{ . }}" target="_blank" rel="noopener" 
                           class="inline-flex items-center justify-center w-16 h-16 bg-[#1DB954] text-white rounded-full hover:opacity-90 transition-opacity">
                            <i class="fa-brands fa-spotify icon-lg"></i>
                        </a>
                        {{ end }}
                        {{ with .apple_podcasts }}
                        <a href="{{ . }}" target="_blank" rel="noopener" 
                           class="inline-flex items-center justify-center w-16 h-16 bg-[#9933FF] text-white rounded-full hover:opacity-90 transition-opacity">
                            <i class="fa-solid fa-podcast icon-lg"></i>
                        </a>
                        {{ end }}
                        {{ with .deezer }}
                        <a href="{{ . }}" target="_blank" rel="noopener" 
                           class="inline-flex items-center justify-center w-16 h-16 bg-[#FF0092] text-white rounded-full hover:opacity-90 transition-opacity">
                            <i class="fa-brands fa-deezer icon-lg"></i>
                        </a>
                        {{ end }}
                        {{ with .youtube }}
                        <a href="{{ . }}" target="_blank" rel="noopener" 
                           class="inline-flex items-center justify-center w-16 h-16 bg-[#FF0000] text-white rounded-full hover:opacity-90 transition-opacity">
                            <i class="fa-brands fa-youtube icon-lg"></i>
                        </a>
                        {{ end }}
                    </div>
                </div>
                {{ end }}
                {{ end }}

            </div>
        </aside>

        {{/* ══════════════════════════════════════════════════════════
             CONTENU PRINCIPAL
             ══════════════════════════════════════════════════════════ */}}
        <div class="lg:w-2/3"> 
            
            {{/* Header Desktop */}}
            <div class="hidden md:block">
                <header class="mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        {{ if eq $ep.episode_type "trailer" }}
                        <span class="inline-block bg-tertiary text-white text-xs px-2 py-1 rounded-full">Bande-annonce</span>
                        {{ else if eq $ep.episode_type "bonus" }}
                        <span class="inline-block bg-tertiary text-white text-xs px-2 py-1 rounded-full">Bonus</span>
                        {{ end }}
                    </div>
                    <p class="text-sm font-semibold text-tertiary uppercase">{{ $ep.subtitle | default "Podcast" }}</p>
                    <h1 class="podcast-section text-3xl font-extrabold text-secondary mt-1">{{ $ep.title }}</h1>
                </header>
                
                {{/* Invités - Desktop */}}
                {{ with $ep.guests }}{{ if gt (len .) 0 }}
                <div class="flex flex-wrap items-center gap-4 mb-8 p-4 border-l-4 border-t-4 border-accent-primary text-primary bg-primary rounded-r-lg">
                    {{ range . }}
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-accent-primary">person</span>
                        <span class="font-bold">Invité(e) :</span>
                        <span>{{ . }}</span>
                    </div>
                    {{ end }}
                </div>
                {{ end }}{{ end }}
            </div>
            
            {{/* Contenu Markdown */}}
            <section class="prose prose-lg max-w-none text-primary">
                {{ .Content }}
            </section>
            
            <hr class="text-accent-primary my-8">

            {{/* Ressources mentionnées */}}
            {{ with .Params.resources }}
            <div class="mb-8">
                <h3 class="font-bold text-primary mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-accent-primary">bookmark</span>
                    Ressources mentionnées
                </h3>
                <ul class="space-y-2">
                    {{ range . }}
                    <li class="flex items-start gap-2">
                        {{ if eq .type "book" }}
                        <span class="material-symbols-outlined text-tertiary text-lg">menu_book</span>
                        {{ else if eq .type "video" }}
                        <span class="material-symbols-outlined text-tertiary text-lg">play_circle</span>
                        {{ else if eq .type "tool" }}
                        <span class="material-symbols-outlined text-tertiary text-lg">build</span>
                        {{ else }}
                        <span class="material-symbols-outlined text-tertiary text-lg">link</span>
                        {{ end }}
                        <a href="{{ .url }}" target="_blank" rel="noopener" 
                           class="text-accent-primary hover:underline">
                            {{ .title }}
                        </a>
                    </li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}

            {{/* Transcription */}}
            {{ with .Params.transcript }}
            {{ if .available }}
            <div class="mb-8 p-4 bg-primary rounded-lg">
                <h3 class="font-bold text-primary mb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-accent-primary">description</span>
                    Transcription
                </h3>
                {{ if .url }}
                <a href="{{ .url }}" target="_blank" rel="noopener" 
                   class="inline-flex items-center gap-1 text-accent-primary hover:underline">
                    <span class="material-symbols-outlined text-sm">download</span>
                    Télécharger la transcription
                </a>
                {{ else }}
                <p class="text-sm text-tertiary">Transcription disponible sur demande.</p>
                {{ end }}
            </div>
            {{ end }}
            {{ end }}

{{/* ══════════════════════════════════════════════════════════════════
     VIDÉOS YOUTUBE (Auto-extraction de l'ID)
     ══════════════════════════════════════════════════════════════════ */}}

     {{ if or .Params.youtube_video_url_01 .Params.youtube_video_url_02 }}
     <section class="mt-12 mb-8">
         <h3 class="font-bold text-primary mb-6 flex items-center gap-2">
             <span class="material-symbols-outlined text-accent-primary">videocam</span>
             Vidéos associées
         </h3>
         
         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
             {{/* Vidéo 01 */}}
             {{ with .Params.youtube_video_url_01 }}
                 {{ $id := replaceRE "^.*(?:(?:youtu\\.be\\/|v\\/|vi\\/|u\\/\\w\\/|embed\\/|shorts\\/)|(?:(?:watch)?\\?v(?:i)?=|\\&v(?:i)?=))([^#\\&\\?]*).*" "$1" . }}
                 <div class="rounded-xl overflow-hidden shadow-lg bg-black aspect-video">
                     {{ (printf `{{< youtube "%s" >}}` $id) | $.Page.RenderString }}
                 </div>
             {{ end }}
     
             {{/* Vidéo 02 */}}
             {{ with .Params.youtube_video_url_02 }}
                 {{ $id := replaceRE "^.*(?:(?:youtu\\.be\\/|v\\/|vi\\/|u\\/\\w\\/|embed\\/|shorts\\/)|(?:(?:watch)?\\?v(?:i)?=|\\&v(?:i)?=))([^#\\&\\?]*).*" "$1" . }}
                 <div class="rounded-xl overflow-hidden shadow-lg bg-black aspect-video">
                     {{ (printf `{{< youtube "%s" >}}` $id) | $.Page.RenderString }}
                 </div>
             {{ end }}
         </div>
     </section>
     {{ end }}
        </div>
    </article>
</div>

{{/* Autres épisodes */}}
{{/* On définit les variables pour compter les épisodes */}}
{{ $currentPage := . }}
{{ $allPodcasts := where site.RegularPages "Section" "podcasts" }}
{{ $otherPodcasts := where $allPodcasts "Permalink" "ne" $currentPage.Permalink }}

{{/* Condition : on affiche le div et le partial seulement si >= 2 */}}
{{ $otherPodcasts := where (where site.RegularPages "Section" "podcasts") "Permalink" "ne" .Permalink }}
{{ if ge (len $otherPodcasts) 2 }}
  <div>
    {{ partial "other_podcasts.html" . }}
  </div>
{{ end }}

<div>
    {{ partial "services-cta.html" . }}
</div>
{{ end }}