{{- $podcast := .Site.Params.podcast -}}
{{- $pages := where .Site.RegularPages "Section" "podcasts" -}}
{{- $pages = where $pages ".Params.block" "!=" true -}}
{{- $pages = where $pages "Draft" false -}}
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" 
     xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
     xmlns:podcast="https://podcastindex.org/namespace/1.0"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>{{ $podcast.title | default .Site.Title }}</title>
    <link>{{ .Site.BaseURL }}podcasts/</link>
    <description>{{ $podcast.description | plainify | htmlUnescape }}</description>
    <language>{{ $podcast.language | default "fr" }}</language>
    <copyright>© {{ now.Year }} {{ $podcast.author }}. Tous droits réservés.</copyright>
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>
    <generator>Hugo {{ hugo.Version }}</generator>
    <atom:link href="{{ .Site.BaseURL }}podcasts/index.xml" rel="self" type="application/rss+xml"/>
    <itunes:type>episodic</itunes:type>
    <itunes:author>{{ $podcast.author }}</itunes:author>
    <itunes:summary>{{ $podcast.description | plainify | htmlUnescape }}</itunes:summary>
    <itunes:explicit>{{ $podcast.explicit | default false }}</itunes:explicit>
    {{- $podcastImage := $podcast.image | default "/img/podcast-cover.jpg" -}}
    {{- if not (hasPrefix $podcastImage "http") }}{{ $podcastImage = printf "%s%s" .Site.BaseURL (strings.TrimPrefix "/" $podcastImage) }}{{ end }}
    <itunes:image href="{{ $podcastImage }}"/>
    <image>
      <url>{{ $podcastImage }}</url>
      <title>{{ $podcast.title }}</title>
      <link>{{ .Site.BaseURL }}podcasts/</link>
    </image>
    <itunes:category text="{{ $podcast.category | default "Business" }}">
      {{- with $podcast.subcategory }}<itunes:category text="{{ . }}"/>{{ end }}
    </itunes:category>
    <itunes:owner>
      <itunes:name>{{ $podcast.owner_name | default $podcast.author }}</itunes:name>
      <itunes:email>{{ $podcast.owner_email | default $podcast.email }}</itunes:email>
    </itunes:owner>
    <podcast:locked>no</podcast:locked>

{{- range $pages.ByDate.Reverse }}
    {{- $ep := partial "podcasts/episode-data" . }}
    {{- if $ep.audio.url }}
    <item>
      <title>{{ $ep.title }}</title>
      <link>{{ $ep.permalink }}</link>
      <guid isPermaLink="true">{{ $ep.permalink }}</guid>
      <pubDate>{{ $ep.date.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</pubDate>
      <description>{{ $ep.description | plainify | htmlUnescape }}</description>
      <content:encoded><![CDATA[{{ $ep.content | markdownify }}]]></content:encoded>
      <enclosure url="{{ $ep.audio.url }}" length="{{ $ep.audio.file_size }}" type="{{ $ep.audio.format }}"/>
      <itunes:title>{{ $ep.title }}</itunes:title>
      <itunes:summary>{{ $ep.description | plainify | htmlUnescape | truncate 200 }}</itunes:summary>
      <itunes:duration>{{ $ep.audio.duration }}</itunes:duration>
      <itunes:explicit>{{ $ep.explicit }}</itunes:explicit>
      <itunes:episodeType>{{ $ep.episode_type }}</itunes:episodeType>
      <itunes:season>{{ $ep.season }}</itunes:season>
      <itunes:episode>{{ $ep.episode_number }}</itunes:episode>
      <itunes:image href="{{ $ep.image }}"/>
      {{- if $ep.hasChapters }}
      <podcast:chapters url="{{ $ep.permalink }}chapters.json" type="application/json+chapters"/>
      {{- end }}
    </item>
    {{- end }}
{{- end }}
  </channel>
</rss>