{{- /* RSS PODCAST - MGC Coaching
*/ -}}
{{- $podcast := .Site.Params.podcast -}}
{{- $pages := where .Site.RegularPages "Section" "podcasts" -}}
{{- $pages = where $pages ".Params.block" "!=" true -}}
{{- $pages = where $pages "Draft" false -}}
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" 
     xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
     xmlns:podcast="https://podcastindex.org/namespace/1.0"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>{{ $podcast.title | default .Site.Title }}</title>
    <link>{{ .Site.BaseURL }}podcasts/</link>
    <description>{{ $podcast.description | default .Site.Params.description | plainify | htmlUnescape }}</description>
    <language>{{ $podcast.language | default .Site.LanguageCode | default "fr" }}</language>
    <copyright>© {{ now.Year }} {{ $podcast.author | default .Site.Title }}. Tous droits réservés.</copyright>
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>
    <generator>Hugo {{ hugo.Version }}</generator>
    <atom:link href="{{ .Site.BaseURL }}podcasts/index.xml" rel="self" type="application/rss+xml"/>
    <itunes:type>episodic</itunes:type>
    <itunes:author>{{ $podcast.author | default .Site.Title }}</itunes:author>
    <itunes:summary>{{ $podcast.description | default .Site.Params.description | plainify | htmlUnescape }}</itunes:summary>
    <itunes:explicit>{{ if $podcast.explicit }}true{{ else }}false{{ end }}</itunes:explicit>
{{- $podcastImage := $podcast.image | default "/img/podcast-cover.jpg" -}}
{{- if not (hasPrefix $podcastImage "http") -}}
{{- $podcastImage = printf "%s%s" .Site.BaseURL (strings.TrimPrefix "/" $podcastImage) -}}
{{- end }}
    <itunes:image href="{{ $podcastImage }}"/>
    <image>
      <url>{{ $podcastImage }}</url>
      <title>{{ $podcast.title | default .Site.Title }}</title>
      <link>{{ .Site.BaseURL }}podcasts/</link>
    </image>
    <itunes:category text="{{ $podcast.category | default "Business" }}">
{{- with $podcast.subcategory }}
      <itunes:category text="{{ . }}"/>
{{- end }}
    </itunes:category>
    <itunes:owner>
      <itunes:name>{{ $podcast.owner_name | default $podcast.author | default .Site.Title }}</itunes:name>
      <itunes:email>{{ $podcast.owner_email | default $podcast.email | default "contact@example.com" }}</itunes:email>
    </itunes:owner>
    <podcast:locked>no</podcast:locked>

{{- range $pages.ByDate.Reverse }}
    {{- /* ═══════════════════════════════════════════════════════════════════════
           RÉCUPÉRATION AUDIO ET TAILLE
           ═══════════════════════════════════════════════════════════════════════ */ -}}
    {{- $audioUrl := "" -}}
    {{- $audioFormat := .Params.audio_format | default "audio/mpeg" -}}
    {{- $fileSize := .Params.file_size_bytes | default 0 -}}

    {{- /* 1. PRIORITÉ 1 : Champs Decap via préfixe S3/CDN */ -}}
    {{- $prefix := .Params.audio_url_prefix | default "" -}}
    {{- $fileName := .Params.file_name | default "" -}}
    {{- if and $prefix $fileName -}}
      {{- $seasonRaw := .Params.season | default 1 -}}
      {{- $seasonFormatted := printf "s%02d" (int $seasonRaw) -}}
      {{- $audioUrl = printf "%s/%s/%s" $prefix $seasonFormatted $fileName -}}
    {{- end -}}

{{- /* 2. PRIORITÉ 2 : Fichier dans le Page Bundle */ -}}
    {{- if not $audioUrl -}}
      {{- $audioFile := .Params.audio_file -}}
      {{- $resource := "" -}}
      {{- if and $audioFile (not (hasPrefix $audioFile "http")) (not (strings.Contains $audioFile "/")) -}}
        {{- $resource = .Resources.GetMatch $audioFile -}}
      {{- else if not $audioFile -}}
        {{- $resource = index (.Resources.ByType "audio") 0 -}}
      {{- end -}}
      {{- with $resource -}}
        {{- $audioUrl = .Permalink -}}
        {{- $audioFormat = .MediaType.Type -}}
        {{- if eq (int $fileSize) 0 -}}
          {{- /* Tentative de récupération de la taille via plusieurs méthodes Hugo */ -}}
          {{- if .Data.Size -}}
            {{- $fileSize = .Data.Size -}}
          {{- else if .Data.Stat -}}
            {{- $fileSize = .Data.Stat.Size -}}
          {{- else -}}
            {{- $fileSize = len .Content -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- /* 3. PRIORITÉ 3 : URL Directe / Anciens épisodes */ -}}
    {{- if not $audioUrl -}}
      {{- $manualUrl := .Params.audio_file | default .Params.audio_url -}}
      {{- if $manualUrl -}}
        {{- if hasPrefix $manualUrl "http" -}}
          {{- $audioUrl = $manualUrl -}}
        {{- else -}}
          {{- $audioUrl = printf "%s%s" $.Site.BaseURL (strings.TrimPrefix "/" $manualUrl) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- /* 4. RÉCUPÉRATION TAILLE DISTANTE (HEAD Request) */ -}}
    {{- if and $audioUrl (hasPrefix $audioUrl "http") (eq (int $fileSize) 0) -}}
      {{- $opts := dict "method" "HEAD" -}}
      {{- with try (resources.GetRemote $audioUrl $opts) -}}
        {{- with .Value -}}
          {{- $fileSize = .Data.ContentLength | default 0 -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- /* DURATION CONVERSION */ -}}
    {{- $durationRaw := .Params.duration | default "" -}}
    {{- $durationSeconds := 0 -}}
    {{- if ne $durationRaw "" -}}
      {{- $parts := split $durationRaw ":" -}}
      {{- if eq (len $parts) 2 -}}
        {{- $durationSeconds = add (mul (int (index $parts 0)) 60) (int (index $parts 1)) -}}
      {{- else if eq (len $parts) 3 -}}
        {{- $h := mul (int (index $parts 0)) 3600 -}}
        {{- $m := mul (int (index $parts 1)) 60 -}}
        {{- $s := int (index $parts 2) -}}
        {{- $durationSeconds = add $h (add $m $s) -}}
      {{- end -}}
    {{- end -}}

    {{- /* IMAGE EPISODE */ -}}
    {{- $episodeImage := "" -}}
    {{- $cover := .Params.cover | default .Params.cover_image -}}
    {{- if $cover -}}
      {{- if hasPrefix $cover "http" -}}{{- $episodeImage = $cover -}}
      {{- else -}}{{- $episodeImage = printf "%s%s" $.Site.BaseURL (strings.TrimPrefix "/" $cover) -}}
      {{- end -}}
    {{- else -}}
      {{- with index (.Resources.ByType "image") 0 -}}{{- $episodeImage = .Permalink -}}
      {{- else -}}{{- $episodeImage = printf "%simg/fallback-podcast.jpg" $.Site.BaseURL -}}
      {{- end -}}
    {{- end -}}

    {{- if $audioUrl }}
    <item>
      <title>{{ .Title }}</title>
      <link>{{ .Permalink }}</link>
      <guid isPermaLink="true">{{ .Permalink }}</guid>
      <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</pubDate>
      {{- $desc := .Params.description | default (.Content | plainify | truncate 300) }}
      <description>{{ $desc | plainify | htmlUnescape }}</description>
      <content:encoded><![CDATA[{{ .Content | markdownify }}]]></content:encoded>
      <enclosure url="{{ $audioUrl }}" length="{{ $fileSize }}" type="{{ $audioFormat }}"/>
      <itunes:title>{{ .Title }}</itunes:title>
      <itunes:summary>{{ .Params.description | default ($desc | truncate 200) | plainify | htmlUnescape }}</itunes:summary>
      <itunes:duration>{{ $durationSeconds }}</itunes:duration>
      <itunes:explicit>{{ if .Params.explicit }}true{{ else }}false{{ end }}</itunes:explicit>
      <itunes:episodeType>{{ .Params.episode_type | default "full" }}</itunes:episodeType>
      {{- with .Params.season }}<itunes:season>{{ . }}</itunes:season>{{ end }}
      {{- with .Params.episode_number }}<itunes:episode>{{ . }}</itunes:episode>{{ end }}
      <itunes:image href="{{ $episodeImage }}"/>
      
      {{- with .Params.chapters }}
      <podcast:chapters version="1.2" type="application/json">
        {{- range . }}
        {{- if .title }}
          {{- $p := split .time ":" -}}
          {{- $start := "" -}}
          {{- if eq (len $p) 2 -}}{{- $start = printf "00:%02d:%02d" (int (index $p 0)) (int (index $p 1)) -}}
          {{- else if eq (len $p) 3 -}}{{- $start = printf "%02d:%02d:%02d" (int (index $p 0)) (int (index $p 1)) (int (index $p 2)) -}}
          {{- end -}}
          <podcast:chapter start="{{ $start }}" title="{{ .title }}"/>
        {{- end }}
        {{- end }}
      </podcast:chapters>
      {{- end }}
    </item>
    {{- end }}
{{- end }}
  </channel>
</rss>